<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Removing the boring parts from geocomputation with European data • latlon2map</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Removing the boring parts from geocomputation with European data">
<meta property="og:description" content="latlon2map">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">latlon2map</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/removing_the_boring.html">Removing the boring parts from geocomputation with European data</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="removing_the_boring_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Removing the boring parts from geocomputation with European data</h1>
            
      
      
      <div class="hidden name"><code>removing_the_boring.Rmd</code></div>

    </div>

    
    
<p>There are a number of small things that unneccesarily complicate using geographic data in Europe. The fact that even mapping data released by Eurostat <a href="https://ec.europa.eu/eurostat/web/gisco/geodata/reference-data/administrative-units-statistical-units">are not distributed with a license that allows for their re-distribution</a>, makes it more difficult to liberally pre-process and distribute such data as is common for example in the United States where they are usually released in the public domain.<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> But beyond the licensing, there are still a number of small operations to do - find the data, download, uncompress, import in a useful format - and they all take time, and are boring, and demotivating.</p>
<p>So instead of spending time trying to make a map that is nice and useful, users (I have in mind data journalists, but this may relate to other users as well) waste a lot of time getting the data into R. They also end up having multiple copies of similar datasets, and end up sharing code that is not reproducible. How does it happen?</p>
<p>Let’s say I make a visualisation of electoral data. I use a geographic dataset on municipalities, and store it somewhere in my working folder. If I share the code, I often do not share also the geographic dataset due to size or licensing issues… I can then make a textual reference, or include a lot of boilerplate code that downloads the data if they are not locally available, uncompress, import, process them, etc. Even if I do all of the above, when the following week I will make another map for an article on climate change, I will end up redownloading the dataset, etc., ending up with multiple copies of the same geographic dataset. If I keep my folders synced, this also implies a lot of unnecessary files stored in the cloud, slowing the sync of the few lines of code that I’d actually like to be synced.</p>
<p>The package <code>latlon2map</code> deals with all of the above, easing the pain of the R user doing geocomputation. The package addresses the needs of data journalists and data enthusiasts, will be of particular use to non-experienced R programmers, but will likely be useful to users with all levels of experience. Please bear in mind that the package is functional, but is at an early stage of development, and is targeted mainly at Europe-based users.</p>
<div id="getting-the-data" class="section level2">
<h2 class="hasAnchor">
<a href="#getting-the-data" class="anchor"></a>Getting the data</h2>
<p>The core idea of <code>latlon2map</code> is to make the process of caching geographic datasets as frictionless but also as transparent as possible.</p>
<p>The first thing to do is to set a folder where all data will be cached. This should normally by a folder that you do not sync, e.g. </p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"ggplot2"</span>, <span class="kw">quietly</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"dplyr"</span>, <span class="kw">quietly</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'dplyr'</span>
<span class="co">#&gt; The following objects are masked from 'package:stats':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     filter, lag</span>
<span class="co">#&gt; The following objects are masked from 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     intersect, setdiff, setequal, union</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"sf"</span>, <span class="kw">quietly</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
<span class="co">#&gt; Linking to GEOS 3.8.1, GDAL 3.1.1, PROJ 6.3.1</span>

<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"latlon2map"</span>)
<span class="co">#ll_set_folder(path = "~/R")</span></pre></body></html></div>
<p>All functions to get maps start with <code>ll_get_</code> to facilitate auto-completion, and all of them output <code>sf</code> objects with crs 4326. As such, they can be directly used in graphs, without even the need to store them as separate objects.</p>
<p>If I want a map with local administrative units in the UK, for example, I can run the following code.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>()+
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="fu"><a href="../reference/ll_get_lau_eu.html">ll_get_lau_eu</a></span>() <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">CNTR_CODE</span> <span class="kw">==</span> <span class="st">"UK"</span>))
<span class="co">#&gt; ℹ © EuroGeographics for the administrative boundaries</span></pre></body></html></div>
<p><img src="removing_the_boring_files/figure-html/unnamed-chunk-2-1.png" width="576"></p>
<p>The first time that this is run it will download data from Eurostat’s website, unzip it, import as an <code>sf</code> object, and store it locally for quick retrieval. This means that if you run the same piece of code a second time, it will print the map almost instantly.</p>
<p>Here is for example the code for having NUTS2 regions in Italy.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>()+
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="fu"><a href="../reference/ll_get_nuts_eu.html">ll_get_nuts_eu</a></span>(<span class="kw">level</span> <span class="kw">=</span> <span class="fl">2</span>) <span class="kw">%&gt;%</span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">CNTR_CODE</span> <span class="kw">==</span> <span class="st">"IT"</span>))
<span class="co">#&gt; ℹ © EuroGeographics for the administrative boundaries</span>
<span class="co">#&gt; ℹ Source: https://ec.europa.eu/eurostat/web/gisco/geodata/reference-data/administrative-units-statistical-units/countries</span></pre></body></html></div>
<p><img src="removing_the_boring_files/figure-html/unnamed-chunk-3-1.png" width="576"></p>
<p>Or with higher resolution:</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>()+
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="fu"><a href="../reference/ll_get_nuts_eu.html">ll_get_nuts_eu</a></span>(<span class="kw">level</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">resolution</span> <span class="kw">=</span> <span class="fl">1</span>) <span class="kw">%&gt;%</span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">CNTR_CODE</span> <span class="kw">==</span> <span class="st">"IT"</span>))
<span class="co">#&gt; ℹ © EuroGeographics for the administrative boundaries</span>
<span class="co">#&gt; ℹ Source: https://ec.europa.eu/eurostat/web/gisco/geodata/reference-data/administrative-units-statistical-units/countries</span></pre></body></html></div>
<p><img src="removing_the_boring_files/figure-html/unnamed-chunk-4-1.png" width="576"></p>
<p>Check all the available options looking at the help files, e.g. <code><a href="../reference/ll_get_nuts_eu.html">?ll_get_nuts_eu</a></code>.</p>
<p>The package may include data from other statistical services; currently, it integrates geographic data published by Istat in Italy to have higher detail.</p>
<p>This for example shows the boundary of the city of Bologna, in Italy. The data for the specific geographic unit are also cached separately, so a second run of this code will give the result almost immediatelye (to clarify: if will not open the full dataset and filter for Bologna, but will open a pre-cached file with only the data for Bologna to increase speed and reduce memory requirements).</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>()+
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="fu"><a href="../reference/ll_get_nuts_it.html">ll_get_nuts_it</a></span>(<span class="kw">name</span> <span class="kw">=</span> <span class="st">"Bologna"</span>, <span class="kw">level</span> <span class="kw">=</span> <span class="st">"lau"</span>, <span class="kw">resolution</span> <span class="kw">=</span> <span class="st">"high"</span>))
<span class="co">#&gt; ℹ Source: https://www.istat.it/it/archivio/222527</span>
<span class="co">#&gt; ℹ Istat (CC-BY)</span></pre></body></html></div>
<p><img src="removing_the_boring_files/figure-html/unnamed-chunk-5-1.png" width="576"></p>
<p>What is important is that this code can easily be shared and will work even if the geographics datasets are not previously present on the computer where the same code will be run. Even if you have many different projects using this data, only one copy will need to be stored on a given workstation.</p>
<p>Information on copyright is displayed on the console at each call of the function unless <code>silent = TRUE</code> is enabled.</p>
<p>The original shapefiles and the accompanying documentation remains stored under the folder <code>ll_data</code>.</p>
</div>
<div id="getting-the-right-proportions" class="section level2">
<h2 class="hasAnchor">
<a href="#getting-the-right-proportions" class="anchor"></a>Getting the right proportions</h2>
<p>Another small nuisance is related to including in the same post maps or areas with different proportions.</p>
<p>For example, Portugal and the Netherlands have different shapes, but I’d like to have all maps in my my post with the same height/width ratio. This is slightly complicated by the fact that scales are in degrees, so it take some effort to get get them right. The function <code>ll_bbox</code> takes care of this, so that instead of some maps that are very wide, and some that are very tall, e.g. </p>
<div class="sourceCode" id="cb6"><html><body><pre class="r">remotes::install_github("paleolimbot/ggspatial", upgrade = "never", quiet = TRUE)
library("ggspatial")

sf_reference &lt;- ll_get_nuts_eu(level = 2, resolution = 1) %&gt;% filter(CNTR_CODE == "SE")
#&gt; ℹ © EuroGeographics for the administrative boundaries
#&gt; ℹ Source: https://ec.europa.eu/eurostat/web/gisco/geodata/reference-data/administrative-units-statistical-units/countries
ggplot() +
    annotation_map_tile(type = "stamenbw", zoomin = 0, cachedir = fs::path(ll_set_folder(), "ll_data")) +
  geom_sf(data = sf_reference, colour = "darkred", fill = NA)
#&gt; Zoom: 5
#&gt; Fetching 12 missing tiles
#&gt; 
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |======                                                                |   8%
  |                                                                            
  |============                                                          |  17%
  |                                                                            
  |==================                                                    |  25%
  |                                                                            
  |=======================                                               |  33%
  |                                                                            
  |=============================                                         |  42%
  |                                                                            
  |===================================                                   |  50%
  |                                                                            
  |=========================================                             |  58%
  |                                                                            
  |===============================================                       |  67%
  |                                                                            
  |====================================================                  |  75%
  |                                                                            
  |==========================================================            |  83%
  |                                                                            
  |================================================================      |  92%
  |                                                                            
  |======================================================================| 100%
#&gt; ...complete!
#&gt; Warning in showSRID(uprojargs, format = "PROJ", multiline = "NO"): Discarded
#&gt; ellps WGS 84 in CRS definition: +proj=merc +a=6378137 +b=6378137 +lat_ts=0
#&gt; +lon_0=0 +x_0=0 +y_0=0 +k=1 +units=m +nadgrids=@null +wktext +no_defs
#&gt; Warning in showSRID(uprojargs, format = "PROJ", multiline = "NO"): Discarded
#&gt; datum WGS_1984 in CRS definition
#&gt; Warning in showSRID(uprojargs, format = "PROJ", multiline = "NO"): Discarded
#&gt; ellps WGS 84 in CRS definition: +proj=merc +a=6378137 +b=6378137 +lat_ts=0
#&gt; +lon_0=0 +x_0=0 +y_0=0 +k=1 +units=m +nadgrids=@null +wktext +no_defs
#&gt; Warning in showSRID(uprojargs, format = "PROJ", multiline = "NO"): Discarded
#&gt; datum WGS_1984 in CRS definition</pre></body></html></div>
<p><img src="removing_the_boring_files/figure-html/unnamed-chunk-6-1.png" width="576"></p>
<p>…we can have this all of them with the same proportion.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r">ggplot() +
    annotation_map_tile(type = "stamenbw", zoomin = 0, cachedir = fs::path(ll_set_folder(), "ll_data")) +
    geom_sf(data = sf::st_as_sfc(ll_bbox(sf = sf_reference,ratio = "4:3")), fill = NA, color = NA) +
  geom_sf(data = sf_reference, colour = "darkred", fill = NA)
#&gt; Zoom: 5
#&gt; Fetching 8 missing tiles
#&gt; 
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |=========                                                             |  12%
  |                                                                            
  |==================                                                    |  25%
  |                                                                            
  |==========================                                            |  38%
  |                                                                            
  |===================================                                   |  50%
  |                                                                            
  |============================================                          |  62%
  |                                                                            
  |====================================================                  |  75%
  |                                                                            
  |=============================================================         |  88%
  |                                                                            
  |======================================================================| 100%
#&gt; ...complete!
#&gt; Warning in showSRID(uprojargs, format = "PROJ", multiline = "NO"): Discarded
#&gt; ellps WGS 84 in CRS definition: +proj=merc +a=6378137 +b=6378137 +lat_ts=0
#&gt; +lon_0=0 +x_0=0 +y_0=0 +k=1 +units=m +nadgrids=@null +wktext +no_defs
#&gt; Warning in showSRID(uprojargs, format = "PROJ", multiline = "NO"): Discarded
#&gt; datum WGS_1984 in CRS definition
#&gt; Warning in showSRID(uprojargs, format = "PROJ", multiline = "NO"): Discarded
#&gt; ellps WGS 84 in CRS definition: +proj=merc +a=6378137 +b=6378137 +lat_ts=0
#&gt; +lon_0=0 +x_0=0 +y_0=0 +k=1 +units=m +nadgrids=@null +wktext +no_defs
#&gt; Warning in showSRID(uprojargs, format = "PROJ", multiline = "NO"): Discarded
#&gt; datum WGS_1984 in CRS definition</pre></body></html></div>
<p><img src="removing_the_boring_files/figure-html/unnamed-chunk-7-1.png" width="576"></p>
</div>
<div id="get-the-population-grid" class="section level2">
<h2 class="hasAnchor">
<a href="#get-the-population-grid" class="anchor"></a>Get the population grid</h2>
<p>There are more complex geographic data than simple boundary lines. Eurostat for example published a population grid, pointing at how many people lives in each square km of the continent. Such data can be useful for a number of analyses, but they tend to come in big files. Again, <code>lonlat2map</code> caches the result, including pre-processed data if a consistent name is provided.</p>
<p>[the following code chunks are not evaluated for facilitating auto-deploy of the website with vignette]</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">name</span> <span class="kw">&lt;-</span> <span class="st">"Wien"</span>

<span class="no">sf_location</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/ll_get_lau_eu.html">ll_get_lau_eu</a></span>(<span class="kw">name</span> <span class="kw">=</span> <span class="no">name</span>)

<span class="no">desired_bbox</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sf/man/st_as_sfc.html">st_as_sfc</a></span>(<span class="fu"><a href="../reference/ll_bbox.html">ll_bbox</a></span>(<span class="kw">sf</span> <span class="kw">=</span> <span class="no">sf_location</span>, <span class="kw">ratio</span> <span class="kw">=</span> <span class="st">"16:9"</span>))

<span class="no">lau_grid_name</span> <span class="kw">&lt;-</span> <span class="kw pkg">stringr</span><span class="kw ns">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span>(<span class="no">name</span>, <span class="st">"_lau_high-st_intersects"</span>)

<span class="no">sf_location_grid</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/ll_get_population_grid.html">ll_get_population_grid</a></span>(<span class="kw">match_sf</span> <span class="kw">=</span> <span class="no">sf_location</span>,
                                           <span class="kw">match_name</span> <span class="kw">=</span> <span class="no">lau_grid_name</span>,
                                           <span class="kw">match_country</span> <span class="kw">=</span> <span class="st">"AT"</span>,
                                           <span class="kw">join</span> <span class="kw">=</span> <span class="kw pkg">sf</span><span class="kw ns">::</span><span class="no"><a href="https://rdrr.io/pkg/sf/man/geos_binary_pred.html">st_intersects</a></span>,
                                           <span class="kw">silent</span> <span class="kw">=</span> <span class="fl">TRUE</span>) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span>(<span class="kw">`Nr. of residents`</span> <span class="kw">=</span> <span class="no">TOT_P</span>)

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>() +
    <span class="fu">annotation_map_tile</span>(<span class="kw">type</span> <span class="kw">=</span> <span class="st">"stamenbw"</span>, <span class="kw">zoomin</span> <span class="kw">=</span> <span class="fl">0</span>, <span class="kw">cachedir</span> <span class="kw">=</span> <span class="kw pkg">fs</span><span class="kw ns">::</span><span class="fu"><a href="http://fs.r-lib.org/reference/path.html">path</a></span>(<span class="fu"><a href="../reference/ll_set_folder.html">ll_set_folder</a></span>(), <span class="st">"ll_data"</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">desired_bbox</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="fl">NA</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="fl">NA</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">sf_location_grid</span>,
            <span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">fill</span> <span class="kw">=</span> <span class="no">`Nr. of residents`</span>), <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html">scale_fill_viridis_c</a></span>() +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">sf_location</span>,
            <span class="kw">colour</span> <span class="kw">=</span> <span class="st">"darkred"</span>,
            <span class="kw">size</span> <span class="kw">=</span> <span class="fl">2</span>,
            <span class="kw">fill</span> <span class="kw">=</span> <span class="fl">NA</span>,
            <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.8</span>) +
      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">title</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="no">sf_location</span>$<span class="no">LAU_LABEL</span>),
       <span class="kw">subtitle</span> <span class="kw">=</span> <span class="st">"Administrative boundaries and population grid"</span>,
       <span class="kw">caption</span> <span class="kw">=</span> <span class="st">"Source: © EuroGeographics for the administrative boundaries
       Data source population grid information: Eurostat, EFGS
       Map tiles by Stamen Design, under CC BY 3.0
       Base map data by OpenStreetMap, under ODbL."</span>)</pre></body></html></div>
</div>
<div id="population-weighted-centre" class="section level2">
<h2 class="hasAnchor">
<a href="#population-weighted-centre" class="anchor"></a>Population-weighted centre</h2>
<p><code>lonlat2map</code> includes some convenience functions to deal with normally tedious processes, e.g. finding the population-weighted center of an area.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">name</span> <span class="kw">=</span> <span class="st">"Palmanova"</span>
<span class="no">sf_location</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/ll_get_nuts_it.html">ll_get_nuts_it</a></span>(<span class="kw">name</span> <span class="kw">=</span> <span class="no">name</span>, <span class="kw">level</span> <span class="kw">=</span> <span class="st">"lau"</span>, <span class="kw">resolution</span> <span class="kw">=</span> <span class="st">"high"</span>, <span class="kw">silent</span> <span class="kw">=</span> <span class="fl">TRUE</span>)

<span class="no">centroid</span> <span class="kw">&lt;-</span> <span class="kw pkg">sf</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/sf/man/geos_unary.html">st_centroid</a></span>(<span class="no">sf_location</span> <span class="kw">%&gt;%</span>
                              <span class="kw pkg">sf</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/sf/man/st_transform.html">st_transform</a></span>(<span class="kw">crs</span> <span class="kw">=</span> <span class="fl">3857</span>)) <span class="kw">%&gt;%</span>
  <span class="kw pkg">sf</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/sf/man/st_transform.html">st_transform</a></span>(<span class="kw">crs</span> <span class="kw">=</span> <span class="fl">4326</span>)

<span class="no">desired_bbox</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sf/man/st_as_sfc.html">st_as_sfc</a></span>(<span class="fu"><a href="../reference/ll_bbox.html">ll_bbox</a></span>(<span class="kw">sf</span> <span class="kw">=</span> <span class="no">sf_location</span>, <span class="kw">ratio</span> <span class="kw">=</span> <span class="st">"4:3"</span>))

<span class="no">lau_grid_name_temp</span> <span class="kw">&lt;-</span> <span class="kw pkg">stringr</span><span class="kw ns">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span>(<span class="no">name</span>, <span class="st">"_lau_high-st_intersects"</span>)

<span class="no">sf_location_grid</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/ll_get_population_grid.html">ll_get_population_grid</a></span>(<span class="kw">match_sf</span> <span class="kw">=</span> <span class="no">sf_location</span>,
                                           <span class="kw">match_name</span> <span class="kw">=</span> <span class="no">lau_grid_name_temp</span>,
                                           <span class="kw">match_country</span> <span class="kw">=</span> <span class="st">"IT"</span>,
                                           <span class="kw">join</span> <span class="kw">=</span> <span class="kw pkg">sf</span><span class="kw ns">::</span><span class="no"><a href="https://rdrr.io/pkg/sf/man/geos_binary_pred.html">st_intersects</a></span>,
                                           <span class="kw">silent</span> <span class="kw">=</span> <span class="fl">TRUE</span>)

<span class="no">pop_centroid</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/ll_find_pop_centre.html">ll_find_pop_centre</a></span>(<span class="kw">sf_location</span> <span class="kw">=</span> <span class="no">sf_location</span>,
                                   <span class="kw">sf_population_grid</span> <span class="kw">=</span> <span class="no">sf_location_grid</span>,
                                   <span class="kw">power</span> <span class="kw">=</span> <span class="fl">2</span>)

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>() +
    <span class="fu">annotation_map_tile</span>(<span class="kw">type</span> <span class="kw">=</span> <span class="st">"stamenbw"</span>, <span class="kw">zoomin</span> <span class="kw">=</span> <span class="fl">0</span>, <span class="kw">cachedir</span> <span class="kw">=</span> <span class="kw pkg">fs</span><span class="kw ns">::</span><span class="fu"><a href="http://fs.r-lib.org/reference/path.html">path</a></span>(<span class="fu"><a href="../reference/ll_set_folder.html">ll_set_folder</a></span>(), <span class="st">"ll_data"</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">desired_bbox</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="fl">NA</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="fl">NA</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">sf_location_grid</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span>(<span class="kw">`Nr. of residents`</span> <span class="kw">=</span> <span class="no">TOT_P</span>),
            <span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">fill</span> <span class="kw">=</span> <span class="no">`Nr. of residents`</span>), <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html">scale_fill_viridis_c</a></span>() +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">sf_location</span>,
            <span class="kw">colour</span> <span class="kw">=</span> <span class="st">"darkred"</span>,
            <span class="kw">size</span> <span class="kw">=</span> <span class="fl">2</span>,
            <span class="kw">fill</span> <span class="kw">=</span> <span class="fl">NA</span>,
            <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.8</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">centroid</span>,
          <span class="kw">colour</span> <span class="kw">=</span> <span class="st">"darkred"</span>,
          <span class="kw">fill</span> <span class="kw">=</span> <span class="st">"coral"</span>,
          <span class="kw">size</span> <span class="kw">=</span> <span class="fl">5</span>,
          <span class="kw">shape</span> <span class="kw">=</span> <span class="fl">21</span>,
          <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.8</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">pop_centroid</span>,
          <span class="kw">colour</span> <span class="kw">=</span> <span class="st">"blue4"</span>,
          <span class="kw">fill</span> <span class="kw">=</span> <span class="st">"cornflowerblue"</span>,
          <span class="kw">size</span> <span class="kw">=</span> <span class="fl">5</span>,
          <span class="kw">shape</span> <span class="kw">=</span> <span class="fl">21</span>,
          <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.8</span>) +
      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">title</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="no">sf_location</span>$<span class="no">COMUNE</span>),
       <span class="kw">subtitle</span> <span class="kw">=</span> <span class="st">"Administrative boundaries and population grid
Centroid in red, population-weighted centre in blue"</span>,
       <span class="kw">caption</span> <span class="kw">=</span> <span class="st">"Source: © EuroGeographics for the administrative boundaries
       Data source population grid information: Eurostat, EFGS
       Map tiles by Stamen Design, under CC BY 3.0
       Base map data by OpenStreetMap, under ODbL."</span>)</pre></body></html></div>
<p>The function is flexible, and can be used with more granular population data such as those <a href="https://dataforgood.fb.com/docs/methodology-high-resolution-population-density-maps-demographic-estimates/">distributed by Facebook</a>, which can be loaded with the function <code><a href="../reference/ll_get_population_grid_hr.html">ll_get_population_grid_hr()</a></code>.</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">lau_grid_name_temp</span> <span class="kw">&lt;-</span> <span class="kw pkg">stringr</span><span class="kw ns">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span>(<span class="no">name</span>, <span class="st">"_lau_hr-st_intersects"</span>)

<span class="no">sf_location_grid_hr</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/ll_get_population_grid_hr.html">ll_get_population_grid_hr</a></span>(<span class="kw">geo</span> <span class="kw">=</span> <span class="st">"IT"</span>,
                          <span class="kw">match_sf</span> <span class="kw">=</span> <span class="no">sf_location</span>,
                          <span class="kw">match_name</span> <span class="kw">=</span> <span class="no">lau_grid_name_temp</span>,
                          <span class="kw">join</span> <span class="kw">=</span> <span class="kw pkg">sf</span><span class="kw ns">::</span><span class="no"><a href="https://rdrr.io/pkg/sf/man/geos_binary_pred.html">st_intersects</a></span>,
                          <span class="kw">silent</span> <span class="kw">=</span> <span class="fl">TRUE</span>)

<span class="no">pop_centroid_hr</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/ll_find_pop_centre.html">ll_find_pop_centre</a></span>(<span class="kw">sf_location</span> <span class="kw">=</span> <span class="no">sf_location</span>,
                                       <span class="kw">sf_population_grid</span> <span class="kw">=</span> <span class="no">sf_location_grid_hr</span>,
                                       <span class="kw">power</span> <span class="kw">=</span> <span class="fl">5</span>)

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>() +
    <span class="fu">annotation_map_tile</span>(<span class="kw">type</span> <span class="kw">=</span> <span class="st">"stamenbw"</span>, <span class="kw">zoomin</span> <span class="kw">=</span> <span class="fl">0</span>, <span class="kw">cachedir</span> <span class="kw">=</span> <span class="kw pkg">fs</span><span class="kw ns">::</span><span class="fu"><a href="http://fs.r-lib.org/reference/path.html">path</a></span>(<span class="fu"><a href="../reference/ll_set_folder.html">ll_set_folder</a></span>(), <span class="st">"ll_data"</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">desired_bbox</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="fl">NA</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="fl">NA</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">sf_location_grid_hr</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span>(<span class="kw">`Nr. of residents`</span> <span class="kw">=</span> <span class="no">Population</span>),
            <span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">colour</span> <span class="kw">=</span> <span class="no">`Nr. of residents`</span>), <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html">scale_colour_viridis_c</a></span>() +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">sf_location</span>,
            <span class="kw">colour</span> <span class="kw">=</span> <span class="st">"darkred"</span>,
            <span class="kw">size</span> <span class="kw">=</span> <span class="fl">2</span>,
            <span class="kw">fill</span> <span class="kw">=</span> <span class="fl">NA</span>,
            <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.8</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">centroid</span>,
          <span class="kw">colour</span> <span class="kw">=</span> <span class="st">"darkred"</span>,
          <span class="kw">fill</span> <span class="kw">=</span> <span class="st">"coral"</span>,
          <span class="kw">size</span> <span class="kw">=</span> <span class="fl">5</span>,
          <span class="kw">shape</span> <span class="kw">=</span> <span class="fl">21</span>,
          <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.8</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">pop_centroid_hr</span>,
          <span class="kw">colour</span> <span class="kw">=</span> <span class="st">"blue4"</span>,
          <span class="kw">fill</span> <span class="kw">=</span> <span class="st">"cornflowerblue"</span>,
          <span class="kw">size</span> <span class="kw">=</span> <span class="fl">5</span>,
          <span class="kw">shape</span> <span class="kw">=</span> <span class="fl">21</span>,
          <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.8</span>) +
      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">title</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="no">sf_location</span>$<span class="no">COMUNE</span>),
       <span class="kw">subtitle</span> <span class="kw">=</span> <span class="st">"Administrative boundaries and population grid
Centroid in red, population-weighted centre in blue"</span>,
       <span class="kw">caption</span> <span class="kw">=</span> <span class="st">"Source: © EuroGeographics for the administrative boundaries
       Facebook High Resolution Population Density Maps (CC-BY)
       Map tiles by Stamen Design, under CC BY 3.0
       Base map data by OpenStreetMap, under ODbL."</span>)</pre></body></html></div>
</div>
<div id="more-to-come" class="section level2">
<h2 class="hasAnchor">
<a href="#more-to-come" class="anchor"></a>More to come</h2>
<p>This package was started while writing <a href="https://codebase.giorgiocomai.eu/2020/03/25/population-weighted-centre/">a blog post</a>, and not everything may work smoothly at this stage. Feel free to get in touch with the author or <a href="https://github.com/giocomai/latlon2map">file an issue on GitHub</a>.</p>
<p>Future versions of <code>lonlat2map</code> will have integrated support for more data sources, as well as additional functions to facilitate common use cases.</p>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>The licensing is particularly problematic since it does not allow to use the data “for commercial purposes”: does this mean that data journalists can or cannot use these data? If somebody in relevant EU institutions reads this, I beg you, please, please, release geographic data in the public domain.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Giorgio Comai.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
